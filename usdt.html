<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Import USDT — Flash UI</title>
<style>
:root {
    --bg: #000000;
    --accent: #ffffff;
    --muted: rgba(255,255,255,0.75);
}

html,body {
    height:100%;margin:0;
    background:var(--bg);
    color:var(--accent);
    font-family:Inter,system-ui;
}
.wrap {
    min-height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
}
.card {
    width:100%;
    max-width:420px;
    text-align:center;
    background:rgba(255,255,255,0.02);
    border-radius:14px;
    padding:28px 26px;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow:0 10px 30px rgba(255,255,255,0.04);
}
.title {
    font-size:20px;
    font-weight:600;
    margin:0 0 8px
}
.subtitle {
    margin:0;
    font-size:13px;
    color:var(--muted)
}
.loader-ring {
    margin:22px auto;
    width:56px;height:56px;border-radius:50%;
    border:4px solid rgba(255,255,255,0.08);
    border-top-color:var(--accent);
    animation:spin .9s linear infinite;
}
@keyframes spin {to{transform:rotate(360deg)}}

#status {
    margin-top:8px;
    font-size:15px;
    color:var(--muted)
}
.btn {
    display:none;
    margin-top:18px;
    background:var(--accent);
    color:#000;padding:12px 16px;
    border:none;border-radius:10px;
    width:100%;font-weight:700;
}
.btn-glow {
    animation:glow 1.6s ease-in-out 2
}
@keyframes glow {
    50% {box-shadow:0 0 25px rgba(255,255,255,0.6);}
}

/* Arrow & instruction kept in DOM for layout parity but not used */
.arrow {
    position:fixed;top:10px;right:10px;
    width:46px;height:46px;
    opacity:0;transform:translateY(-10px);
    pointer-events:none;
}
.instruction {
    position:fixed;
    top:60px;right:10px;
    background:white;color:black;
    padding:6px 10px;
    border-radius:6px;
    font-size:14px;font-weight:600;
    opacity:0;transform:translateY(-8px);
    pointer-events:none;
}
</style>
</head>

<body>
<div class="wrap">
    <div class="card">
        <h1 class="title">Import USDT</h1>
        <p class="subtitle">Quick and safe — wallet auto-import</p>
        <div id="loader" class="loader-ring"></div>
        <div id="status">Checking wallet…</div>
        <button id="retryBtn" class="btn">Retry Import</button>
    </div>
</div>

<div id="arrow" class="arrow" aria-hidden="true">
<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round">
<path d="M7 17l5-5 5 5"></path>
</svg>
</div>

<div id="instruction" class="instruction" aria-hidden="true">Select BNB Chain</div>

<script>
/*
  Behavior summary:
  - Detect current chainId (eth_chainId).
  - Map chainId -> real USDT token info (address, symbol, decimals, image).
  - If supported, call wallet_watchAsset with correct token metadata.
  - If unsupported chain (including TRON / non-EVM), show friendly message:
      "This network does not support USDT import — choose another network in your wallet"
  - Keep same try/catch flow and retry button behavior.
  - Minimal UI changes (no chain-switch prompts, no arrow/instruction usage).
*/

const CHAIN_TOKEN_MAP = {
    // Ethereum Mainnet
    // USDT (ERC-20) — decimals 6
    "0x1": {
        address: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
        symbol: "USDT",
        decimals: 6,
        image: "https://s2.coinmarketcap.com/static/img/coins/64x64/825.png"
    },
    // BNB Smart Chain (chainId 56 = 0x38)
    // USDT (BEP-20) — decimals 18
    "0x38": {
        address: "0x55d398326f99059fF775485246999027B3197955",
        symbol: "USDT",
        decimals: 18,
        image: "https://s2.coinmarketcap.com/static/img/coins/64x64/825.png"
    }
    // Add more chains here if you want (Polygon, Avalanche, etc.)
    // Example (uncomment and set correct address if you add):
    // "0x89": { address: "...", symbol: "USDT", decimals: 6, image: "..." } // Polygon
};

const statusEl = document.getElementById("status");
const loader = document.getElementById("loader");
const retryBtn = document.getElementById("retryBtn");
const arrow = document.getElementById("arrow");
const instruction = document.getElementById("instruction");
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

// helper show/hide for retry (keeps same behaviour)
function showRetry(){ retryBtn.style.display = "block"; }
function hideRetry(){ retryBtn.style.display = "none"; }

// Keep arrow/instruction hidden (we no longer instruct to switch network)
function hideNetworkHint(){ arrow.classList.remove("show"); instruction.classList.remove("show"); }
hideNetworkHint();

// get current chainId (returns string like "0x1")
async function getChainIdSafe() {
    try {
        if (!window.ethereum) return null;
        return await ethereum.request({ method: "eth_chainId" });
    } catch (e) {
        return null;
    }
}

// Build token metadata object suitable for wallet_watchAsset
function buildTokenOptions(tokenInfo) {
    return {
        type: "ERC20",
        options: {
            address: tokenInfo.address,
            symbol: tokenInfo.symbol,
            decimals: tokenInfo.decimals,
            image: tokenInfo.image
        }
    };
}

async function autoImport() {
    hideNetworkHint();
    hideRetry();
    loader.style.display = "block";
    statusEl.textContent = "Requesting wallet…";

    // Confirm ethereum provider present
    if (!window.ethereum) {
        loader.style.display = "none";
        if (!isMobile) {
            statusEl.innerHTML = `Extension not found<br><a style="color:white" href="https://metamask.io/download/">Install MetaMask</a>`;
        } else {
            statusEl.textContent = "Open in wallet browser";
        }
        return;
    }

    // Determine chain
    const chainId = await getChainIdSafe();

    // Map to token info
    const tokenInfo = chainId ? CHAIN_TOKEN_MAP[chainId] : null;

    if (!tokenInfo) {
        // Unsupported network (including TRON or non-EVM)
        loader.style.display = "none";
        statusEl.textContent = "This network does not support USDT import — choose another network in your wallet";
        showRetry();
        return;
    }

    // Try import using wallet_watchAsset (keeps your try/catch logic)
    try {
        const added = await ethereum.request({
            method: "wallet_watchAsset",
            params: buildTokenOptions(tokenInfo)
        });
        loader.style.display = "none";
        if (added) {
            statusEl.textContent = "Token added ✅";
            retryBtn.classList.add("btn-glow");
            setTimeout(()=>retryBtn.classList.remove("btn-glow"),2000);
        } else {
            statusEl.textContent = "Import cancelled";
            showRetry();
        }
    } catch (e) {
        loader.style.display = "none";
        statusEl.textContent = "Failed — Try again";
        showRetry();
    }
}

// Listen for chain changes and try import again automatically (no network prompt)
if (window.ethereum) {
    ethereum.on("chainChanged", (newChainId) => {
        // When chainChanged fires, attempt import on new chain (keeps behavior simple)
        // Hide retry and attempt an import automatically
        loader.style.display = "block";
        statusEl.textContent = "Network changed — checking token...";
        // small delay to allow wallet to update internal state
        setTimeout(() => {
            autoImport();
        }, 500);
    });
}

// wire retry
retryBtn.onclick = autoImport;

// initialize (same entry behaviour)
async function init() {
    await new Promise(r => setTimeout(r, 1000));

    if (!window.ethereum) {
        if (!isMobile) {
            loader.style.display = "none";
            statusEl.innerHTML =
                `Extension not found<br><a style="color:white" href="https://metamask.io/download/">Install MetaMask</a>`;
            return;
        }
        await new Promise(r => setTimeout(r, 1000));
        if (!window.ethereum) {
            loader.style.display = "none";
            statusEl.innerHTML = "Open in wallet browser";
            return;
        }
    }

    // Directly attempt import on whatever chain is currently selected.
    autoImport();
}

init();
</script>
</body>
</html>
